<script>
  import { onMount, getContext } from "svelte";
  import { writable } from "svelte/store";
  import {
    jsonData,
    cartData,
    visibility,
    logged,
    user,
    loginData,
    cartCount
  } from "./store.js";
  import { md5 } from "./md5.js";

  export let type = "addToCart";
  export let collection = "products";
  export let document = {};
  export let dataDismiss = "";

  let btnType = "";
  let handler = () => {};
  let classes = "";
  let url = "";

  function toggle() {
    logged.set(!$logged);
    if ($visibility == "hidden") visibility.set("");
    else visibility.set("hidden");
  }

  function clearData() {
    loginData.nick = "";
    loginData.password = "";
    window.document.getElementById("loginNick").value = "";
    window.document.getElementById("loginPassword").value = "";
  }

  const URL = getContext("URL");
  onMount(() => {
    switch (type) {
      case "addToCart":
        handler = addToCart;
        classes = "btn btn-dark btn-addToCart";
        break;
      case "register":
        handler = register;
        classes = "btn btn-primary btn-register";
        btnType = "submit";
        break;
      case "login":
        handler = login;
        classes = "btn btn-primary pull-right btn-login";
        break;
      case "logout":
        handler = logout;
        classes = "btn btn-outline-light my-0 ml-2 my-sm-0 btn-logout";
        break;
      default:
    }
    switch (collection) {
      case "products":
        url = URL.products;
        break;
      case "users":
        url = URL.users;
        break;
      case "carts":
        url = URL.carts;
        break;
      case "purchases":
        url = URL.purchases;
        break;
      default:
    }
  });

  async function getCount() {
    const response = await fetch(URL.carts + "user/" + user.data._id);
    const data = await response.json();
    data.forEach(element => {
      $cartCount++;
    });
  }

  function addToCart() {
    $cartData = { userId: user.data._id, productId: document._id, amount: 1 };
    console.log(url);
    if (
      Object.keys($cartData).length > 1 &&
      Object.values($cartData).every(x => x !== undefined && x != "")
    ) {
      fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify($cartData)
      })
        .then(res => res.json())
        .then(data => {
          console.log(data);
        })
        .catch(err => console.log(err));
    }
  }

  function register() {
    window.document
      .getElementById("registerForm")
      .addEventListener("click", function(event) {
        event.preventDefault();
      });
    document.password = md5(document.password);
    if (
      Object.keys(document).length > 1 &&
      Object.values(document).every(x => x !== undefined && x != "")
    ) {
      fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(document)
      })
        .then(res => res.json())
        .then(data => {
          $jsonData = [...$jsonData, data];
          window.location.href = "/";
        })
        .catch(err => console.log(err));
    }
  }

  function login() {
    fetch(URL.users + document.nick, {
      method: "GET"
    })
      .then(res => res.json())
      .then(data => {
        if (
          data.nick == document.nick &&
          data.password == md5(document.password)
        ) {
          user.data = data;
          getCount();
          toggle();
          clearData();
        } else {
          alert("Datos incorrectos");
        }
      })
      .catch(err => console.log(err));
  }

  function logout() {
    user.data = {};
    toggle();
    window.location.href = "/";
  }
</script>

<style>
  .btn-addToCart::after {
    content: "AÃ±adir al carrito";
  }

  .btn-register::after {
    content: "Registrarse";
  }

  .btn-login::after {
    content: "Login";
  }

  .btn-logout::after {
    content: "Logout";
  }
</style>

<button
  data-dismiss={dataDismiss}
  type={btnType}
  class={classes}
  on:click={handler} />
